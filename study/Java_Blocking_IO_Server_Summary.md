# 1단계 Blocking 서버 학습 정리

## 네트워크 기초 개념

### ServerSocket vs Socket
- **ServerSocket**: 클라이언트 연결 요청을 받는 "관문/접수처" 역할
- **Socket**: 특정 클라이언트와 1:1 실제 통신을 담당하는 "통신선"

### TCP 연결 과정 (3-way handshake)
```
클라이언트 → 서버: SYN (연결 요청)
서버 → 클라이언트: SYN-ACK (요청 수락)  
클라이언트 → 서버: ACK (확인)
```

## Blocking I/O 동작 원리

### accept()의 Blocking 특성
```java
Socket clientSocket = serverSocket.accept(); // 여기서 WAITING 상태
```

**내부 동작:**
1. OS 커널에게 "클라이언트 연결 기다려줘" 요청
2. 스레드가 WAITING 상태로 전환 (CPU 사용 안함)
3. 클라이언트 연결 시 OS가 스레드를 깨움
4. Socket 객체 반환하며 메서드 완료

### 스레드 상태 변화
```
RUNNING → WAITING → RUNNING
```

## 현재 구조의 동작 방식

### 스레드 구조
- **main 스레드 1개**: accept() 무한루프 담당
- **클라이언트 스레드 N개**: 각 클라이언트 통신 담당

### 실행 흐름
```java
while (true) {
    Socket clientSocket = serverSocket.accept(); // 빠르게 처리
    new Thread(handler).start(); // 새 스레드 생성 후 바로 다음 루프
}
```

## 스레드와 동시성

### 스레드의 목적
- **동시성**: 여러 작업을 동시에 처리
- **독립성**: 각 스레드는 독립적으로 작동

### 채팅 서버에서 스레드가 필요한 이유
```java
// 동시에 각자 작업
스레드1: 클라이언트A readLine() 대기 중...
스레드2: 클라이언트B readLine() 대기 중...  
스레드3: 클라이언트C readLine() 대기 중...
```

- 실시간성이 핵심
- 한 클라이언트가 메시지를 안 보내도 다른 클라이언트는 정상 처리

## 컨텍스트 스위칭 (Context Switching)

### 개념
CPU가 현재 실행 중인 스레드를 멈추고 다른 스레드로 전환하는 과정

### 저장해야 할 정보 (컨텍스트)
- **CPU 레지스터 값들**: 현재 계산 중인 데이터
- **프로그램 카운터**: 다음에 실행할 명령어 위치  
- **스택 포인터**: 현재 스택 위치
- **메모리 관리 정보**: 가상 메모리 매핑 테이블

### 동작 과정
```
스레드A 실행 중 → 컨텍스트 저장 → 스레드B로 전환 → 스레드B 컨텍스트 복원 → 스레드B 실행
```

### 오버헤드가 발생하는 이유
- 저장/복원 작업 자체가 시간 소모
- 스레드가 많을수록 전환 빈도 증가
- CPU 캐시 무효화 (새 스레드 데이터로 교체)

## 현재 구조의 문제점 (C10K 문제)

### 스레드 폭발
- 클라이언트 1만명 = 스레드 1만개
- **메모리 부족**: 스레드당 약 1MB 스택 메모리
- **컨텍스트 스위칭 오버헤드**: CPU가 스레드 간 전환 시 발생하는 비용
- **OS 스레드 한계**: 운영체제가 생성할 수 있는 스레드 개수 제한

### 컨텍스트 스위칭 오버헤드 상세
**저장/복원해야 할 정보:**
- CPU 레지스터 값들
- 프로그램 카운터  
- 스택 포인터
- 메모리 관리 정보

**성능 저하 원인:**
- 저장/복원 작업 자체의 시간 소모
- 스레드 수 증가 → 전환 빈도 증가
- CPU 캐시 무효화

### 왜 스레드 재사용이 어려운가?
- **웹 서버**: 요청 → 처리 → 응답 → 스레드 반납 ✅
- **채팅 서버**: 연결 → 계속 대기 → 연결 끊을 때까지... ❌

## 핵심 깨달음
1. **Blocking I/O**는 스레드를 WAITING 상태로 만듦
2. **동시성**을 위해서는 각 클라이언트마다 독립 스레드 필요
3. **스레드 폭발** 문제로 인해 확장성 한계 존재
4. **컨텍스트 스위칭**으로 인한 성능 저하 발생
5. 다음 단계에서 **NIO와 Selector**로 이 문제를 해결해야 함
